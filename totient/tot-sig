#!/opt/mathsg/bin/perl
use strict;
use warnings;
use Math::Prime::Util qw{ inverse_totient euler_phi };
use lib '../lib';
use H::Diag qw{ diag keep_diag };

=head1 totient-signature

By analogy with oeis:A309981, we define the totient-signature a(n)
as the length of the shortest list [ \phi(n + i) ]_i=0^{a(n)-1} that
uniquely identifies n.

Since we calculate this using inverse_totient(t) for increasing values of
t, the results are safe only for n <= max(t).

=cut

my $start = shift(@ARGV) || 2;
my @seen;
for (my $t = $start; 1; $t += 2) {
#   diag($t) unless $t % 1e6;   # show progress
    diag("$t: " . show_seen()), keep_diag() unless $t % 1e6;
    my @v = inverse_totient($t);
    next unless @v;
    try(\@v, 1);
}
exit 0;

sub show_seen {
    return sprintf "[%s]", join ' ', map $_ // 0, splice @seen;
}

sub try {
    my($v, $d) = @_;
    if ($d == 2) {
        ++$seen[$_ % 8] for @$v;
    }
    my %td;
    push @{ $td{euler_phi($_ + $d)} }, $_ for @$v;
    # try to release memory as we go
    {
        my @short = delete @td{ grep @{ $td{$_} } == 1, keys %td };
        if (@short && $d > 2) {
            keep_diag();
            printf "%s [%s]\n", $d + 1, join ' ', map @$_, @short;
        }
    }
    my @long = delete @td{keys %td};
    while (@long) {
        my $va = pop @long;
        try($va, $d + 1);
    }
}
__END__
Math-Prime-Util-0.73 has a memory leak in inverse_totient() (see
https://github.com/danaj/Math-Prime-Util/issues/45), which limits how
far we can check; with the fixed (but not yet released) code from github
we can check further - so far up to \phi(n) = 1e9.

a(n) = 2 for nearly all small values of n.
a(n) = 1 requires | \phi^{-1}(\phi(n)) | = 1; to the best of my knowledge
it is an open question whether such n exists.

n: a(n) = 3, n < 1e3:
    7   9  43  49  72  79 112 143 144 155
  156 168 225 231 287 305 327 351 371 387
  395 399 403 441 480 510 520 549 582 612
  627 675 688 712 720 736 784 790 792 802
  924

All cases of a(n) = 4 with \phi(n) < 1e9:
  2601630 2613510 32324236 32365816 61376256 61454592

Number of cases by range of totients of (2, 3, 4, ...) numbers matching
on phi(n) and phi(n+1):
1000000: 4459 73 1
2000000: 2476 53 1
3000000: 2025 23 2
4000000: 1800 20
5000000: 1601 22 2
6000000: 1490 15 1
7000000: 1347 20 1
8000000: 1307 14
9000000: 1250 12
10000000: 1193 23
11000000: 1154 14 1
12000000: 1162 15
13000000: 1070 7 1
14000000: 1065 12
15000000: 1008 12 3
16000000: 1015 13
17000000: 923 9
18000000: 1004 7 1
19000000: 964 5 1
20000000: 963 10 1
21000000: 914 11
22000000: 878 13
23000000: 833 9
24000000: 836 12
25000000: 851 6
26000000: 796 11
27000000: 818 4
28000000: 825 10
29000000: 798 5 2
30000000: 798 7
31000000: 733 9
32000000: 780 7
33000000: 752 10
34000000: 768 11
35000000: 808 12 2
36000000: 760 6
37000000: 672 7
38000000: 766 7
39000000: 707 11
40000000: 796 5 1

Distribution of n mod 8 for numbers matching on phi(n) and phi(n+1):
1000000: [2144 686 1072 866 1390 583 1028 1372]
2000000: [1171 378 610 468 799 359 577 753]
3000000: [1010 315 454 401 595 289 450 613]
4000000: [859 298 418 366 574 278 353 514]
5000000: [781 277 355 342 468 209 344 500]
6000000: [686 236 355 301 427 232 329 463]
7000000: [676 195 331 249 397 186 301 423]
8000000: [611 218 302 262 383 184 294 402]
9000000: [606 179 294 221 383 178 263 412]
10000000: [559 203 292 247 359 194 241 360]
11000000: [532 171 274 263 349 159 261 345]
12000000: [576 186 243 207 367 179 245 366]
13000000: [522 179 271 214 278 140 243 318]
14000000: [499 167 264 204 333 147 241 311]
15000000: [510 165 228 196 297 130 224 314]
16000000: [526 152 269 198 285 132 195 312]
17000000: [415 155 239 176 284 139 179 286]
18000000: [518 159 243 182 320 115 224 272]
19000000: [402 162 216 191 274 133 226 343]
20000000: [456 150 230 175 286 145 239 279]
21000000: [446 156 208 190 262 141 183 275]
22000000: [448 140 190 146 283 130 188 270]
23000000: [397 135 197 149 252 131 176 256]
24000000: [411 142 196 176 232 115 188 248]
25000000: [402 121 195 183 256 101 196 266]
26000000: [385 111 192 171 222 111 187 246]
27000000: [380 127 195 183 231 115 169 248]
28000000: [403 147 186 152 215 144 177 256]
29000000: [374 120 186 169 233 95 172 270]
30000000: [387 137 173 150 213 116 176 265]
31000000: [352 110 160 151 209 102 167 242]
32000000: [377 130 184 170 206 115 185 214]
33000000: [360 124 202 125 213 100 165 245]
34000000: [360 146 176 153 207 109 169 249]
35000000: [383 137 184 169 259 116 163 249]
36000000: [367 125 208 144 215 119 132 228]
37000000: [331 92 154 143 182 101 146 216]
38000000: [351 129 162 149 229 101 167 265]
39000000: [367 92 176 153 233 84 140 202]
40000000: [348 128 186 158 248 116 177 250]
41000000: [305 84 136 122 192 91 123 185]
42000000: [362 106 161 137 223 94 147 195]
43000000: [319 90 151 134 197 91 135 238]
44000000: [304 146 146 143 230 108 149 217]
45000000: [338 102 154 129 190 104 172 220]
46000000: [311 100 174 133 178 101 112 207]
47000000: [309 109 146 122 158 84 144 214]
48000000: [280 95 158 152 206 85 155 199]
49000000: [284 93 142 120 177 74 144 197]
50000000: [298 92 143 100 163 100 107 205]
